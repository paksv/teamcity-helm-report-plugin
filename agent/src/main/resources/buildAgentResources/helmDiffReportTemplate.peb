<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>helm diff – changes</title>
    <!-- JetBrains Ring UI base stylesheet (contains CSS variables and component styles) -->
    <link rel="stylesheet" href="https://unpkg.com/@jetbrains/ring-ui@latest/dist/style.css" />
    <style>
        /* Map local tokens to JetBrains Ring UI theme variables with sensible fallbacks */
        :root {
            --bg: var(--ring-content-background, #0b0d12);
            --fg: var(--ring-text-color, #e6e8ef);
            --muted: var(--ring-secondary-color, #a7adbb);
            --row: var(--ring-content-background, #111621);
            --border: var(--ring-line-color, #222836);
            --changed: var(--ring-warning-color, #ffb020);
            --added: var(--ring-success-color, #22c55e);
            --deleted: var(--ring-error-color, #ef4444);
        }
        /* Standalone light/dark fallbacks when Ring variables are not provided (e.g., local file) */
        @media (prefers-color-scheme: light) {
            :root {
                --bg: var(--ring-content-background, #ffffff);
                --fg: var(--ring-text-color, #222222);
                --muted: var(--ring-secondary-color, #6b7280);
                --row: var(--ring-content-background, #ffffff);
                --border: var(--ring-line-color, #e5e7eb);
            }
            /* Ensure code chips use light background in light theme when Ring variables are absent */
            code { background: var(--ring-selected-background, #f5f7fa); }
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: var(--ring-content-background, #0b0d12);
                --fg: var(--ring-text-color, #e6e8ef);
                --muted: var(--ring-secondary-color, #a7adbb);
                --row: var(--ring-content-background, #111621);
                --border: var(--ring-line-color, #222836);
            }
            /* In dark theme, ensure code chips use dark background when Ring vars are absent */
            code { background: var(--ring-selected-background, #0d1220); }
        }
        body { background: var(--bg); color: var(--fg); font: 14px/1.428 var(--ring-font-family, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial); margin: 0; padding: 24px; }
        .wrap { max-width: 1100px; margin: 0 auto; }
        .toolbar { display:flex; align-items:center; gap:8px; margin: 0 0 12px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        thead th {
            text-align: left; font-weight: 600; color: var(--muted);
            padding: 10px 14px; border-bottom: 1px solid var(--border);
            position: sticky; top: 0; background: var(--bg); z-index: 1;
        }
        tbody tr { background: var(--row); }
        tbody tr + tr td { border-top: 1px solid var(--border); }
        td { padding: 10px 14px; white-space: nowrap; }
        td.kind, td.name, td.ns { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 260px; }
        code { background: var(--ring-selected-background); border: 1px solid var(--border); padding: 1px 6px; border-radius: 6px; }
        .pill {
            display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; letter-spacing: .02em; line-height: 1;
            padding: 4px 8px; border-radius: 999px; border: 1px solid transparent;
        }

        .pill.added   { color: var(--added); background: transparent; border-color: var(--added); }
        .pill.changed { color: var(--changed); background: transparent; border-color: var(--changed); }
        .pill.deleted { color: var(--deleted); background: transparent; border-color: var(--deleted); }

        .legend { display:flex; gap:10px; }
        .legend .pill { cursor: default; }
        .sr { position:absolute; left:-9999px; }
        /* Icon utilities: use Ring UI SVGs as masks so they inherit currentColor */
        .icon { display:block; width:12px; height:12px; background-color: currentColor; -webkit-mask-repeat:no-repeat; mask-repeat:no-repeat; -webkit-mask-position:center; mask-position:center; -webkit-mask-size:contain; mask-size:contain; }
        .icon-svg { display:block; width:12px; height:12px; fill: currentColor; }
        .icon-add { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="%23000" d="M5 1h2v4h4v2H7v4H5V7H1V5h4z"/></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><path fill="%23000" d="M5 1h2v4h4v2H7v4H5V7H1V5h4z"/></svg>'); }
        .icon-modified { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><g stroke="%23000" stroke-width="2" stroke-linecap="round"><line x1="6" y1="2" x2="6" y2="10"/><line x1="3" y1="3" x2="9" y2="9"/><line x1="9" y1="3" x2="3" y2="9"/></g></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><g stroke="%23000" stroke-width="2" stroke-linecap="round"><line x1="6" y1="2" x2="6" y2="10"/><line x1="3" y1="3" x2="9" y2="9"/><line x1="9" y1="3" x2="3" y2="9"/></g></svg>'); }
        .icon-remove { -webkit-mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><rect fill="%23000" x="1" y="5" width="10" height="2"/></svg>'); mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><rect fill="%23000" x="1" y="5" width="10" height="2"/></svg>'); }

        /* Expand/collapse button */
        .expander-btn { appearance: none; background: transparent; border: none; color: var(--muted); width: 20px; height: 20px; border-radius: 6px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; padding: 0; }
        .expander-btn:hover { color: var(--fg); }
        .chev { display:inline-grid; place-items:center; width:16px; height:16px; transition: transform .15s ease; transform-origin: 50% 50%; }
        .chev::before { content: '\25B8'; /* ▶ */ display:block; line-height: 16px; font-size: 18px; }
        .expander-btn[aria-expanded="true"] .chev { transform: rotate(90deg); }

        /* Diff styles */
        .diff-wrap { background: var(--ring-selected-background); border: 1px solid var(--border); border-radius: 8px; padding: 8px 0; overflow: hidden; }
        .diff { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; line-height: 1.5; margin: 0; overflow: auto; white-space: pre; padding: 0 12px; }
        .diff-line { display:block; padding: 0 6px; border-left: 3px solid transparent; }
        .diff-line.added { color: color-mix(in lab, var(--added) 70%, var(--fg) 30%); background: color-mix(in lab, var(--added) 10%, transparent); border-left-color: color-mix(in lab, var(--added) 70%, var(--fg) 30%); }
        .diff-line.deleted { color: color-mix(in lab, var(--deleted) 70%, var(--fg) 30%); background: color-mix(in lab, var(--deleted) 10%, transparent); border-left-color: color-mix(in lab, var(--deleted) 70%, var(--fg) 30%); }
        .diff-line.hunk { color: color-mix(in lab, var(--changed) 70%, var(--fg) 30%); background: color-mix(in lab, var(--changed) 10%, transparent); }
        .diff-line.meta, .diff-line.file { color: var(--muted); }
        .diff-row { display: none; }
        .diff-row.open { display: table-row; }
        td.diff-cell { padding-top: 0; padding-bottom: 12px; }

        /* Column hover highlight */
        th, td { transition: background-color .12s ease; }
        .col-hover { background-color: var(--ring-selected-background); }
        tbody tr.main-row td { cursor: pointer; }
    </style>
</head>
<body>
<div class="wrap">
    <div class="toolbar" role="toolbar" aria-label="Legend and actions">
        <div class="legend" aria-hidden="true">
            <span class="pill added" title="Added"><span class="icon icon-add" aria-hidden="true"></span><span class="sr">ADDED</span></span>
            <span class="pill changed" title="Modified"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 12 12" aria-hidden="true" class="icon-svg"><path fill-rule="evenodd" d="M1.148 4.38c.22-.22.575-.22.795 0l.796.795a.58.58 0 0 1 .064.077h6.53a.571.571 0 0 1 .065-.077l.795-.795a.563.563 0 0 1 .796.795l-.08.079a.374.374 0 0 1 .341.373v.375c0 .182-.13.334-.301.368l.075.076a.563.563 0 0 1-.795.795l-.796-.795a.56.56 0 0 1-.058-.069H2.832a.566.566 0 0 1-.058.069l-.795.795a.562.562 0 1 1-.796-.795l.069-.069h-.127a.375.375 0 0 1-.375-.375v-.375c0-.207.168-.375.375-.375h.1l-.077-.077a.562.562 0 0 1 0-.795Z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M7.187 10.726a.563.563 0 0 1-.397-.689l.29-1.087a.564.564 0 0 1 .035-.094L3.85 3.201a.567.567 0 0 1-.099-.017l-1.086-.292a.563.563 0 0 1 .29-1.086l.108.029a.375.375 0 0 1 .154-.482l.324-.187a.375.375 0 0 1 .47.077l.027-.103a.563.563 0 0 1 1.087.29l-.291 1.088a.566.566 0 0 1-.03.084l3.271 5.666c.03.003.059.009.088.016l1.087.292a.562.562 0 1 1-.291 1.086l-.094-.025.064.11a.375.375 0 0 1-.138.512l-.324.188a.375.375 0 0 1-.513-.138l-.05-.086-.028.105a.563.563 0 0 1-.689.398Z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M2.335 9.296a.563.563 0 0 1 .397-.69l1.087-.29a.56.56 0 0 1 .1-.018l3.264-5.655a.566.566 0 0 1-.034-.094l-.292-1.087a.562.562 0 1 1 1.087-.291l.029.108a.375.375 0 0 1 .493-.108l.325.187c.158.091.224.28.168.445l.103-.028a.563.563 0 0 1 .291 1.087l-1.086.291a.566.566 0 0 1-.089.016l-3.27 5.667a.566.566 0 0 1 .03.084l.29 1.087a.563.563 0 0 1-1.086.29l-.025-.092-.064.11a.375.375 0 0 1-.512.136l-.325-.187a.375.375 0 0 1-.137-.512l.05-.087-.105.029a.562.562 0 0 1-.69-.398Z" clip-rule="evenodd"></path></svg><span class="sr">CHANGED</span></span>
            <span class="pill deleted" title="Removed"><span class="icon icon-remove" aria-hidden="true"></span><span class="sr">DELETED</span></span>
        </div>
    </div>

    <table aria-label="Helm diff changes">
        <thead>
        <tr>
            <th style="width:28px">Diff</th>
            <th style="width:120px">Change</th>
            <th style="width:120px">Kind</th>
            <th>Name</th>
            <th style="width:180px">Namespace</th>
            <th style="width:120px">API</th>
        </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="6" style="color:var(--muted)">No data</td></tr></tbody>
    </table>
</div>

<script>
{# @pebvariable name="planData" type="String" #}
  // Parse the planData string to convert to a JSON object/array.
  const planDataStr = {{ planData | json_encode | raw }};
  const data = JSON.parse(planDataStr);

    // Build icon HTML per bucket. Use inline SVG for Modified to match Bootstrap glyph
    const iconHtml = (bucket) => {
        switch (bucket) {
            case "ADDED":
                return '<span class="icon icon-add" aria-hidden="true"></span>';
            case "DELETED":
                return '<span class="icon icon-remove" aria-hidden="true"></span>';
            default:
                return '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 12 12" aria-hidden="true" class="icon-svg"><path fill-rule="evenodd" d="M1.148 4.38c.22-.22.575-.22.795 0l.796.795a.58.58 0 0 1 .064.077h6.53a.571.571 0 0 1 .065-.077l.795-.795a.563.563 0 0 1 .796.795l-.08.079a.374.374 0 0 1 .341.373v.375c0 .182-.13.334-.301.368l.075.076a.563.563 0 0 1-.795.795l-.796-.795a.56.56 0 0 1-.058-.069H2.832a.566.566 0 0 1-.058.069l-.795.795a.562.562 0 1 1-.796-.795l.069-.069h-.127a.375.375 0 0 1-.375-.375v-.375c0-.207.168-.375.375-.375h.1l-.077-.077a.562.562 0 0 1 0-.795Z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M7.187 10.726a.563.563 0 0 1-.397-.689l.29-1.087a.564.564 0 0 1 .035-.094L3.85 3.201a.567.567 0 0 1-.099-.017l-1.086-.292a.563.563 0 0 1 .29-1.086l.108.029a.375.375 0 0 1 .154-.482l.324-.187a.375.375 0 0 1 .47.077l.027-.103a.563.563 0 0 1 1.087.29l-.291 1.088a.566.566 0 0 1-.03.084l3.271 5.666c.03.003.059.009.088.016l1.087.292a.562.562 0 1 1-.291 1.086l-.094-.025.064.11a.375.375 0 0 1-.138.512l-.324.188a.375.375 0 0 1-.513-.138l-.05-.086-.028.105a.563.563 0 0 1-.689.398Z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M2.335 9.296a.563.563 0 0 1 .397-.69l1.087-.29a.56.56 0 0 1 .1-.018l3.264-5.655a.566.566 0 0 1-.034-.094l-.292-1.087a.562.562 0 1 1 1.087-.291l.029.108a.375.375 0 0 1 .493-.108l.325.187c.158.091.224.28.168.445l.103-.028a.563.563 0 0 1 .291 1.087l-1.086.291a.566.566 0 0 1-.089.016l-3.27 5.667a.566.566 0 0 1 .03.084l.29 1.087a.563.563 0 0 1-1.086.29l-.025-.092-.064.11a.375.375 0 0 1-.512.136l-.325-.187a.375.375 0 0 1-.137-.512l.05-.087-.105.029a.562.562 0 0 1-.69-.398Z" clip-rule="evenodd"></path></svg>';
        }
    };

    // Map various Helm diff verbs to 3 buckets: ADDED / CHANGED / DELETED
    const normalizeChange = (s="") => {
        const x = String(s).toUpperCase();
        if (["ADD","ADDED","CREATE","CREATED","NEW"].includes(x)) return "ADDED";
        if (["DEL","DELETE","DELETED","REMOVE","REMOVED"].includes(x)) return "DELETED";
        // Fallback bucket
        return "CHANGED"; // MODIFY, CHANGE, UPDATE, PATCH, RENAME, etc.
    };

    const pillClass = (bucket) => ({
        "ADDED": "added",
        "CHANGED": "changed",
        "DELETED": "deleted"
    }[bucket] || "changed");

    const iconClass = (bucket) => ({
        "ADDED": "icon-add",
        "CHANGED": "icon-modified",
        "DELETED": "icon-remove"
    }[bucket] || "icon-modified");

    const rows = document.getElementById("rows");
    rows.innerHTML = ""; // clear placeholder

    // Escape HTML for safe rendering in the diff
    const escapeHtml = (s = "") => String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");

    // Render unified diff snippet into HTML with line-level classes
    const renderUnifiedDiff = (snippet = "") => {
        if (!snippet || typeof snippet !== 'string') return '<div class="diff">No diff</div>';
        const lines = snippet.replace(/\r\n?/g, '\n').split('\n');
        const html = lines.map(line => {
            let cls = 'context';
            if (line.startsWith('+++') || line.startsWith('---')) cls = 'file';
            else if (line.startsWith('@@')) cls = 'hunk';
            else if (line.startsWith('+')) cls = 'added';
            else if (line.startsWith('-')) cls = 'deleted';
            else if (line.startsWith('diff ') || line.startsWith('index ') || line.startsWith('new file') || line.startsWith('deleted file')) cls = 'meta';
            return `<span class="diff-line ${cls}">${escapeHtml(line)}</span>`;
        }).join('');
        return `<pre class="diff">${html}</pre>`;
    };

    data.forEach(item => {
        const bucket = normalizeChange(item.change);

        // Main row
        const tr = document.createElement("tr");
        tr.className = "main-row";
        tr.innerHTML = `
      <td><button class="expander-btn" type="button" aria-expanded="false" aria-label="Show diff"><span class="chev" aria-hidden="true"></span><span class="sr">Toggle diff</span></button></td>
      <td><span class="pill ${pillClass(bucket)}" title="${item.change || bucket}">${iconHtml(bucket)}<span class=\"sr\">${bucket}</span></span></td>
      <td class="kind"><code>${item.kind || ""}</code></td>
      <td class="name" title="${item.name || ""}">${item.name || ""}</td>
      <td class="ns"><code>${item.namespace || ""}</code></td>
      <td><code>${item.api || ""}</code></td>
    `;

        // Details diff row (collapsed by default)
        const diffTr = document.createElement("tr");
        diffTr.className = "diff-row";
        const diffHtml = renderUnifiedDiff(item.snippet || "");
        diffTr.innerHTML = `<td></td><td class="diff-cell" colspan="5"><div class="diff-wrap">${diffHtml}</div></td>`;

        // Toggle behavior
        const btn = tr.querySelector('.expander-btn');
        btn.addEventListener('click', () => {
            const isOpen = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', String(!isOpen));
            diffTr.classList.toggle('open', !isOpen);
        });

        rows.appendChild(tr);
        rows.appendChild(diffTr);
    });

    // Column hover highlight logic
    const table = document.querySelector('table');
    const clearColHover = () => {
        document.querySelectorAll('.col-hover').forEach(el => el.classList.remove('col-hover'));
    };
    table.addEventListener('mousemove', (e) => {
        const cell = e.target.closest('td,th');
        if (!cell || !table.contains(cell)) return;
        const idx = cell.cellIndex;
        if (idx == null || idx < 0) return;
        clearColHover();
        // Header
        const headRow = table.tHead && table.tHead.rows && table.tHead.rows[0];
        if (headRow && headRow.cells[idx]) headRow.cells[idx].classList.add('col-hover');
        // Body
        const bodies = table.tBodies ? Array.from(table.tBodies) : [];
        bodies.forEach(tb => Array.from(tb.rows).forEach(r => {
            if (!r.matches('.main-row')) return;
            const c = r.cells[idx];
            if (c) c.classList.add('col-hover');
        }));
    });
    table.addEventListener('mouseleave', clearColHover);

    // Click anywhere in the main row to toggle expand
    rows.addEventListener('click', (e) => {
        if (e.target.closest('.expander-btn')) return; // let the button handle its own click
        const row = e.target.closest('tr.main-row');
        if (!row) return;
        const btn = row.querySelector('.expander-btn');
        if (btn) btn.click();
    });

    // Example of using a Ring UI button: simple refresh action
    document.getElementById("refreshBtn")?.addEventListener("click", () => window.location.reload());
</script>
</body>
</html>